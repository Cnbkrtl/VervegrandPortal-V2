"""
API Yapƒ± Analizi - Shopify ve Sentos API'larƒ±nƒ±n ger√ßek yapƒ±larƒ±nƒ± incele
"""

import requests
import json
from requests.auth import HTTPBasicAuth
import config_manager

def analyze_shopify_product():
    """Mevcut bir Shopify √ºr√ºn√ºn√ºn tam yapƒ±sƒ±nƒ± analiz et"""
    
    credentials = config_manager.load_all_keys()
    
    if not credentials:
        print("‚ùå Ayarlar bulunamadƒ±!")
        return None
    
    headers = {
        'X-Shopify-Access-Token': credentials['shopify_token'],
        'Content-Type': 'application/json'
    }
    
    # GraphQL ile ilk √ºr√ºn√º al
    url = f"https://{credentials['shopify_store']}/admin/api/2024-10/graphql.json"
    
    query = """
    query getFirstProduct {
      products(first: 1) {
        edges {
          node {
            id
            title
            handle
            description
            status
            vendor
            productType
            createdAt
            updatedAt
            totalInventory
            tags
            variants(first: 50) {
              edges {
                node {
                  id
                  title
                  sku
                  inventoryQuantity
                  price
                  compareAtPrice
                  weight
                  weightUnit
                  barcode
                  position
                  selectedOptions {
                    name
                    value
                  }
                  inventoryItem {
                    id
                    tracked
                    requiresShipping
                  }
                }
              }
            }
            images(first: 50) {
              edges {
                node {
                  id
                  url
                  altText
                  width
                  height
                }
              }
            }
          }
        }
      }
    }
    """
    
    try:
        payload = {"query": query}
        response = requests.post(url, headers=headers, json=payload)
        
        if response.status_code == 200:
            data = response.json()
            
            # GraphQL hata kontrol√º
            if data.get('errors'):
                print(f"‚ùå GraphQL errors: {data['errors']}")
                return None
                
            products_data = data.get('data', {}).get('products', {})
            edges = products_data.get('edges', [])
            
            if edges:
                product = edges[0]['node']
                print("üîç SHOPIFY √úR√úN YAPISI (GraphQL):")
                print("=" * 80)
                print(json.dumps(product, indent=2, ensure_ascii=False))
                print("=" * 80)
                
                # Ana alanlarƒ± listele
                print("\nüìã SHOPIFY ANA ALANLAR:")
                for key in product.keys():
                    value_type = type(product[key]).__name__
                    if isinstance(product[key], dict) and 'edges' in product[key]:
                        # GraphQL edge yapƒ±sƒ±
                        edges = product[key]['edges']
                        print(f"  {key}: GraphQL Connection (count: {len(edges)})")
                    elif isinstance(product[key], list) and product[key]:
                        item_type = type(product[key][0]).__name__
                        print(f"  {key}: {value_type}[{item_type}] (count: {len(product[key])})")
                    else:
                        print(f"  {key}: {value_type}")
                
                # Variants yapƒ±sƒ±nƒ± detaylandƒ±r
                if product.get('variants', {}).get('edges'):
                    variant = product['variants']['edges'][0]['node']
                    print("\nüéØ SHOPIFY VARIANT YAPISI:")
                    for key in variant.keys():
                        value_type = type(variant[key]).__name__
                        if isinstance(variant[key], list) and variant[key]:
                            item_type = type(variant[key][0]).__name__
                            print(f"  {key}: {value_type}[{item_type}] (count: {len(variant[key])})")
                        else:
                            print(f"  {key}: {value_type}")
                
                return product
            else:
                print("‚ùå Shopify'da √ºr√ºn bulunamadƒ±!")
                return None
        else:
            print(f"‚ùå Shopify GraphQL API hatasƒ±: {response.status_code} - {response.text}")
            return None
            
    except Exception as e:
        print(f"‚ùå Shopify analiz hatasƒ±: {str(e)}")
        return None

def analyze_sentos_product():
    """Sentos API'dan bir √ºr√ºn√ºn tam yapƒ±sƒ±nƒ± analiz et"""
    
    credentials = config_manager.load_all_keys()
    
    if not credentials:
        print("‚ùå Ayarlar bulunamadƒ±!")
        return None
    
    auth = HTTPBasicAuth(credentials['sentos_api_key'], credentials['sentos_api_secret'])
    
    # ƒ∞lk √ºr√ºn√º al
    url = f"{credentials['sentos_api_url']}/product?page=0&size=1"
    
    try:
        response = requests.get(url, auth=auth)
        
        if response.status_code == 200:
            data = response.json()
            if data.get('data'):
                product = data['data'][0]
                print("üîç SENTOS √úR√úN YAPISI:")
                print("=" * 80)
                print(json.dumps(product, indent=2, ensure_ascii=False))
                print("=" * 80)
                
                # Ana alanlarƒ± listele
                print("\nüìã SENTOS ANA ALANLAR:")
                for key in product.keys():
                    value_type = type(product[key]).__name__
                    if isinstance(product[key], list) and product[key]:
                        item_type = type(product[key][0]).__name__
                        print(f"  {key}: {value_type}[{item_type}] (count: {len(product[key])})")
                    else:
                        print(f"  {key}: {value_type}")
                
                # Variants yapƒ±sƒ±nƒ± detaylandƒ±r
                if product.get('variants'):
                    variant = product['variants'][0]
                    print("\nüéØ SENTOS VARIANT YAPISI:")
                    for key in variant.keys():
                        value_type = type(variant[key]).__name__
                        if isinstance(variant[key], list) and variant[key]:
                            item_type = type(variant[key][0]).__name__
                            print(f"  {key}: {value_type}[{item_type}] (count: {len(variant[key])})")
                        else:
                            print(f"  {key}: {value_type}")
                
                return product
            else:
                print("‚ùå Sentos'ta √ºr√ºn bulunamadƒ±!")
                return None
        else:
            print(f"‚ùå Sentos API hatasƒ±: {response.status_code} - {response.text}")
            return None
            
    except Exception as e:
        print(f"‚ùå Sentos analiz hatasƒ±: {str(e)}")
        return None

def compare_structures(shopify_product, sentos_product):
    """ƒ∞ki API yapƒ±sƒ±nƒ± kar≈üƒ±la≈ütƒ±r ve mapping √∂ner"""
    
    if not shopify_product or not sentos_product:
        print("‚ùå Kar≈üƒ±la≈ütƒ±rma i√ßin her iki √ºr√ºn de gerekli!")
        return
    
    print("\nüîÑ ALAN KAR≈ûILA≈ûTIRMASI:")
    print("=" * 80)
    
    # Temel mapping √∂nerileri
    mapping_suggestions = {
        # Shopify Field -> Sentos Field
        'title': ['name', 'title', 'product_name'],
        'body_html': ['description', 'description_detail', 'product_description'],
        'vendor': ['brand', 'manufacturer', 'supplier'],
        'product_type': ['category', 'type', 'product_type'],
        'tags': ['tags', 'categories', 'keywords'],
        'handle': ['slug', 'permalink', 'url_key'],
        'variants': ['variants', 'options', 'variations']
    }
    
    print("üìã √ñNERƒ∞LEN ALAN E≈ûLE≈ûTƒ∞RMELERƒ∞:")
    for shopify_field, sentos_candidates in mapping_suggestions.items():
        print(f"\nShopify.{shopify_field} -> Sentos:")
        found_fields = []
        for candidate in sentos_candidates:
            if candidate in sentos_product:
                found_fields.append(f"‚úÖ {candidate}")
            else:
                found_fields.append(f"‚ùå {candidate}")
        print("  " + ", ".join(found_fields))
    
    # Variant kar≈üƒ±la≈ütƒ±rmasƒ±
    if shopify_product.get('variants') and sentos_product.get('variants'):
        shopify_variant = shopify_product['variants'][0]
        sentos_variant = sentos_product['variants'][0]
        
        print(f"\nüéØ VARIANT ALAN KAR≈ûILA≈ûTIRMASI:")
        variant_mapping = {
            'price': ['price', 'sale_price', 'cost'],
            'sku': ['sku', 'code', 'product_code'],
            'barcode': ['barcode', 'upc', 'ean'],
            'inventory_quantity': ['stock', 'quantity', 'inventory'],
            'option1': ['color', 'size', 'option1'],
            'option2': ['size', 'color', 'option2']
        }
        
        for shopify_field, sentos_candidates in variant_mapping.items():
            print(f"\nVariant.{shopify_field} -> Sentos:")
            found_fields = []
            for candidate in sentos_candidates:
                if candidate in sentos_variant:
                    found_fields.append(f"‚úÖ {candidate}")
                else:
                    found_fields.append(f"‚ùå {candidate}")
            print("  " + ", ".join(found_fields))

def create_minimal_shopify_product():
    """En minimal Shopify √ºr√ºn olu≈üturma denemesi - GraphQL ile"""
    
    credentials = config_manager.load_all_keys()
    
    if not credentials:
        print("‚ùå Ayarlar bulunamadƒ±!")
        return None
    
    headers = {
        'X-Shopify-Access-Token': credentials['shopify_token'],
        'Content-Type': 'application/json'
    }
    
    url = f"https://{credentials['shopify_store']}/admin/api/2024-10/graphql.json"
    
    # GraphQL mutation ile farklƒ± minimal kombinasyonlarƒ± test et
    test_cases = [
        {
            'name': 'Sadece title',
            'input': {
                'title': 'Test Product - Only Title'
            }
        },
        {
            'name': 'Title + vendor',
            'input': {
                'title': 'Test Product - Title + Vendor',
                'vendor': 'Test Vendor'
            }
        },
        {
            'name': 'Title + product_type',
            'input': {
                'title': 'Test Product - Title + Type',
                'productType': 'Test Type'
            }
        },
        {
            'name': 'Title + vendor + product_type',
            'input': {
                'title': 'Test Product - Complete',
                'vendor': 'Test Vendor',
                'productType': 'Test Type'
            }
        },
        {
            'name': 'Title + status',
            'input': {
                'title': 'Test Product - With Status',
                'status': 'DRAFT'
            }
        }
    ]
    
    # GraphQL mutation
    mutation = """
    mutation productCreate($input: ProductInput!) {
      productCreate(input: $input) {
        product {
          id
          title
          vendor
          productType
          status
        }
        userErrors {
          field
          message
        }
      }
    }
    """
    
    for test_case in test_cases:
        print(f"\nüß™ TEST: {test_case['name']}")
        print(f"üì¶ Input: {json.dumps(test_case['input'], indent=2)}")
        
        try:
            payload = {
                "query": mutation,
                "variables": {
                    "input": test_case['input']
                }
            }
            
            response = requests.post(url, headers=headers, json=payload)
            
            if response.status_code == 200:
                data = response.json()
                
                # GraphQL hata kontrol√º
                if data.get('errors'):
                    print(f"‚ùå GraphQL errors: {data['errors']}")
                    continue
                
                product_create = data.get('data', {}).get('productCreate', {})
                user_errors = product_create.get('userErrors', [])
                
                if user_errors:
                    print(f"‚ùå User errors: {user_errors}")
                    continue
                
                created_product = product_create.get('product', {})
                if created_product:
                    print(f"‚úÖ BA≈ûARILI! Product ID: {created_product.get('id')}")
                    
                    # Olu≈üan √ºr√ºn√º sil (test i√ßin) - GraphQL mutation ile
                    delete_mutation = """
                    mutation productDelete($input: ProductDeleteInput!) {
                      productDelete(input: $input) {
                        deletedProductId
                        userErrors {
                          field
                          message
                        }
                      }
                    }
                    """
                    
                    delete_payload = {
                        "query": delete_mutation,
                        "variables": {
                            "input": {
                                "id": created_product['id']
                            }
                        }
                    }
                    
                    delete_response = requests.post(url, headers=headers, json=delete_payload)
                    if delete_response.status_code == 200:
                        delete_data = delete_response.json()
                        if not delete_data.get('errors') and not delete_data.get('data', {}).get('productDelete', {}).get('userErrors'):
                            print("üóëÔ∏è Test √ºr√ºn√º silindi")
                    
                    return test_case['input']
                else:
                    print("‚ùå √úr√ºn olu≈üturulamadƒ±")
            else:
                print(f"‚ùå BA≈ûARISIZ: {response.status_code}")
                print(f"üìã Response: {response.text}")
                
        except Exception as e:
            print(f"‚ùå Hata: {str(e)}")
    
    return None

if __name__ == "__main__":
    print("üöÄ API YAPI ANALƒ∞Zƒ∞ BA≈ûLATIYOR...")
    print("=" * 80)
    
    # 1. Shopify √ºr√ºn yapƒ±sƒ±nƒ± analiz et
    shopify_product = analyze_shopify_product()
    
    print("\n" + "=" * 80)
    
    # 2. Sentos √ºr√ºn yapƒ±sƒ±nƒ± analiz et
    sentos_product = analyze_sentos_product()
    
    print("\n" + "=" * 80)
    
    # 3. Yapƒ±larƒ± kar≈üƒ±la≈ütƒ±r
    compare_structures(shopify_product, sentos_product)
    
    print("\n" + "=" * 80)
    
    # 4. Minimal Shopify √ºr√ºn olu≈üturma testi
    print("\nüß™ Mƒ∞Nƒ∞MAL SHOPIFY √úR√úN OLU≈ûTURMA TESTƒ∞:")
    minimal_product = create_minimal_shopify_product()
    
    if minimal_product:
        print(f"\n‚úÖ EN Mƒ∞Nƒ∞MAL BA≈ûARILI SHOPIFY √úR√úN YAPISI:")
        print(json.dumps(minimal_product, indent=2, ensure_ascii=False))
    else:
        print("\n‚ùå Hi√ßbir minimal kombinasyon ba≈üarƒ±lƒ± olmadƒ±!")
    
    print("\nüèÅ ANALƒ∞Z TAMAMLANDI!")
